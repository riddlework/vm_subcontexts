<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   width="1200"
   height="820"
   viewBox="0 0 1200 820"
   version="1.1"
   id="svg54"
   sodipodi:docname="subcontext_lifecycle.svg"
   inkscape:version="1.4.2 (ebf0e940d0, 2025-05-08)"
   inkscape:export-filename="subcontext_lifecycle.png"
   inkscape:export-xdpi="96"
   inkscape:export-ydpi="96"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <sodipodi:namedview
     id="namedview54"
     pagecolor="#ffffff"
     bordercolor="#999999"
     borderopacity="1"
     inkscape:showpageshadow="2"
     inkscape:pageopacity="0"
     inkscape:pagecheckerboard="0"
     inkscape:deskcolor="#d1d1d1"
     inkscape:zoom="1.2049733"
     inkscape:cx="600.01328"
     inkscape:cy="438.18397"
     inkscape:window-width="2256"
     inkscape:window-height="1435"
     inkscape:window-x="0"
     inkscape:window-y="0"
     inkscape:window-maximized="1"
     inkscape:current-layer="svg54" />
  <defs
     id="defs1">
    <style
       type="text/css"
       id="style1"><![CDATA[
      .title { font: 700 24px "Helvetica Neue", Arial, sans-serif; fill: #111; }
      .laneLabel { font: 600 16px "Helvetica Neue", Arial, sans-serif; fill: #222; }
      .label { font: 600 15px "Helvetica Neue", Arial, sans-serif; fill: #222; }
      .small { font: 13px "Helvetica Neue", Arial, sans-serif; fill: #333; }
      .note  { font: italic 12px "Helvetica Neue", Arial, sans-serif; fill: #444; }
      .lane { fill: #fbfcfe; stroke: #c6ceda; stroke-width: 1.5; rx: 10; ry: 10; }
      .box  { fill: #f1f5ff; stroke: #6b86c5; stroke-width: 1.8; rx: 10; ry: 10; }
      .disk { fill: #fff6e6; stroke: #c8a768; stroke-width: 1.8; rx: 10; ry: 10; }
      .clientbox { fill: #eefbf1; stroke: #65a777; stroke-width: 1.8; rx: 10; ry: 10; }
      .mmbox { fill: #f5f0ff; stroke: #8a6bc5; stroke-width: 1.8; rx: 10; ry: 10; }
      .action { fill: #ffffff; stroke: #4f91ff; stroke-width: 1.6; rx: 8; ry: 8; }
      .end   { fill: #ffecec; stroke: #d86a6a; stroke-width: 1.8; rx: 10; ry: 10; }
      .arrow { stroke: #333; stroke-width: 2.2; marker-end: url(#arrowhead); fill: none; }
      .dashed{ stroke-dasharray: 6 6; }
      .step  { font: 700 13px "Helvetica Neue", Arial, sans-serif; fill: #666; }
    ]]></style>
    <marker
       id="arrowhead"
       markerWidth="10"
       markerHeight="7"
       refX="9"
       refY="3.5"
       orient="auto">
      <polygon
         points="0 0, 10 3.5, 0 7"
         fill="#333"
         id="polygon1" />
    </marker>
  </defs>
  <text
     class="title"
     x="34"
     y="40"
     id="text1">Lifecycle of a Virtual Memory Subcontext</text>
  <text
     class="note"
     x="34"
     y="64"
     id="text2"
     style="font-style:italic;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Creation → Persistence (image) → Mapping → Execution (mediated by matchmaker) → Return → Unmap/Termination. Multiple clients may map the same image as well as multiple images.</text>
  <!-- Swimlanes -->
  <rect
     class="lane"
     x="20"
     y="90"
     width="1160"
     height="150"
     id="rect2" />
  <text
     class="laneLabel"
     x="36"
     y="118"
     id="text3"
     style="font-style:normal;font-variant:normal;font-weight:600;font-stretch:normal;font-size:16px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Server Process (creates subcontext)</text>
  <rect
     class="lane"
     x="20"
     y="260"
     width="1160"
     height="120"
     id="rect3" />
  <text
     class="laneLabel"
     x="36"
     y="288"
     id="text4"
     style="font-style:normal;font-variant:normal;font-weight:600;font-stretch:normal;font-size:16px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Image File</text>
  <rect
     class="lane"
     x="20"
     y="400"
     width="1160"
     height="170"
     id="rect4" />
  <text
     class="laneLabel"
     x="36"
     y="428"
     id="text5"
     style="font-style:normal;font-variant:normal;font-weight:600;font-stretch:normal;font-size:16px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Client (Host) Process</text>
  <rect
     class="lane"
     x="20"
     y="590"
     width="1160"
     height="190"
     id="rect5" />
  <text
     class="laneLabel"
     x="36"
     y="618"
     id="text6">Matchmaker (client runtime component)</text>
  <!-- Server steps -->
  <rect
     class="box"
     x="60"
     y="130"
     width="260"
     height="80"
     id="rect6" />
  <text
     class="step"
     x="74"
     y="150"
     id="text7">Step 1</text>
  <text
     class="label"
     x="74"
     y="170"
     id="text8">Select regions to serialize</text>
  <text
     class="small"
     x="74"
     y="190"
     id="text9"
     style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Code, static data, entry points, globals</text>
  <rect
     class="box"
     x="360"
     y="130"
     width="260"
     height="80"
     id="rect9" />
  <text
     class="step"
     x="374"
     y="150"
     id="text10">Step 2</text>
  <text
     class="label"
     x="374"
     y="170"
     id="text11">Serialize to image</text>
  <text
     class="small"
     x="374"
     y="190"
     id="text12"
     style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Write header + memory regions</text>
  <rect
     class="end"
     x="659.90735"
     y="129.90733"
     width="208.73192"
     height="80.185333"
     id="rect12" />
  <text
     class="step"
     x="674"
     y="150"
     id="text13">Step 3</text>
  <text
     class="label"
     x="674"
     y="170"
     id="text14">Server terminates</text>
  <text
     class="small"
     x="674"
     y="190"
     id="text15">Process exits after snapshot</text>
  <!-- Arrows within Server -->
  <path
     class="arrow"
     d="M320,170 L360,170"
     id="path15" />
  <path
     class="arrow"
     d="M620,170 L660,170"
     id="path16" />
  <!-- Image file -->
  <rect
     class="disk"
     x="120"
     y="295"
     width="320"
     height="60"
     id="rect16" />
  <text
     class="label"
     x="135"
     y="320"
     id="text16">Subcontext Image File</text>
  <text
     class="small"
     x="135"
     y="338"
     id="text17">Immutable layout; fixed virtual addresses</text>
  <rect
     class="disk"
     x="520"
     y="295"
     width="320"
     height="60"
     id="rect17" />
  <text
     class="label"
     x="535"
     y="320"
     id="text18">Shared across clients</text>
  <text
     class="small"
     x="535"
     y="338"
     id="text19">Single file mapped by many processes</text>
  <!-- Client mapping -->
  <rect
     class="clientbox"
     x="60"
     y="445"
     width="300"
     height="100"
     id="rect19" />
  <text
     class="step"
     x="74"
     y="465"
     id="text20">Step 4</text>
  <text
     class="label"
     x="74"
     y="485"
     id="text21">Client maps image</text>
  <text
     class="small"
     x="74"
     y="505"
     id="text22"
     style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif"><tspan
       sodipodi:role="line"
       id="tspan54"
       x="74"
       y="505">Disjoint memory regions, fixed addresses;</tspan><tspan
       sodipodi:role="line"
       id="tspan55"
       x="74"
       y="521.25">MAP_SHARED | MAP_FIXED</tspan></text>
  <rect
     class="clientbox"
     x="400"
     y="445"
     width="300"
     height="100"
     id="rect22" />
  <text
     class="step"
     x="414"
     y="465"
     id="text23">Step 5</text>
  <text
     class="label"
     x="414"
     y="485"
     id="text24">Invoke entry point</text>
  <text
     class="small"
     x="414"
     y="505"
     id="text25">Function pointer → subcontext code</text>
  <rect
     class="clientbox"
     x="740"
     y="445"
     width="300"
     height="100"
     id="rect25" />
  <text
     class="step"
     x="754"
     y="465"
     id="text26">Step 8</text>
  <text
     class="label"
     x="754"
     y="485"
     id="text27">Unmap / client exits</text>
  <text
     class="small"
     x="754"
     y="505"
     id="text28"
     style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif"><tspan
       sodipodi:role="line"
       id="tspan56"
       x="754"
       y="505">Subcontext removed from</tspan><tspan
       sodipodi:role="line"
       id="tspan57"
       x="754"
       y="521.25">virtual naddress space</tspan></text>
  <!-- Matchmaker actions -->
  <rect
     class="mmbox"
     x="60"
     y="640"
     width="300"
     height="110"
     id="rect28" />
  <text
     class="step"
     x="74"
     y="660"
     id="text29">Step 6</text>
  <text
     class="label"
     x="74"
     y="680"
     id="text30">Enter subcontext</text>
  <text
     class="small"
     x="74"
     y="700"
     id="text31"
     style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif"><tspan
       sodipodi:role="line"
       id="tspan59"
       x="74"
       y="700">Enable subcontext execute;</tspan><tspan
       sodipodi:role="line"
       id="tspan60"
       x="74"
       y="716.25">disable client execute</tspan></text>
  <rect
     class="mmbox"
     x="400"
     y="640"
     width="300"
     height="110"
     id="rect31" />
  <text
     class="step"
     x="414"
     y="660"
     id="text32">Step 7</text>
  <text
     class="label"
     x="414"
     y="680"
     id="text33">Return to client</text>
  <text
     class="small"
     x="414"
     y="700"
     id="text34"
     style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif"><tspan
       sodipodi:role="line"
       id="tspan61"
       x="414"
       y="700">Re-enable client execute;</tspan><tspan
       sodipodi:role="line"
       id="tspan62"
       x="414"
       y="716.25">disable subcontext execute</tspan></text>
  <!-- Arrows: server -> image -->
  <path
     class="arrow"
     d="m 790,210 c 15.43182,0 107.57478,58.64552 103.04725,88.19866 -4.27414,27.89921 -79.84396,28.46113 -114.78958,27.63123"
     id="path34"
     sodipodi:nodetypes="csc" />
  <path
     class="arrow"
     d="m 620.83432,210 c -40,0 -132.11822,119.97936 -232.11822,119.97936"
     id="path36"
     sodipodi:nodetypes="cc" />
  <!-- Arrows: image -> client map -->
  <path
     class="arrow"
     d="m 280,355 c -39.83491,48.36085 -13.56722,78.23703 -13.56722,113.23703"
     id="path37"
     sodipodi:nodetypes="cc" />
  <path
     class="arrow"
     d="m 680,355 c -16.80287,38.68345 53.78966,89.63761 30.33437,125.91341 -15.06425,23.29828 -53.23815,9.49347 -64.27304,8.90086"
     id="path38"
     sodipodi:nodetypes="csc" />
  <!-- Arrows: client invoke -> matchmaker enter -->
  <path
     class="arrow dashed"
     d="m 550,545 c 0,14.91928 -127.36477,47.25874 -157.17198,75.06011 -25.62417,23.89983 27.03082,44.22934 -12.60869,49.75252 -84.23652,11.73711 -48.22493,-0.67082 -90.54952,6.7027"
     id="path39"
     sodipodi:nodetypes="cssc" />
  <text
     class="note"
     x="322.94812"
     y="583.48468"
     id="text39"
     style="font-style:italic;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">SIGSEGV → matchmaker</text>
  <!-- Arrows: matchmaker enter -> return to client -->
  <path
     class="arrow"
     d="m 210,750 c 0,15.33064 190.90254,46.27031 278.58176,36.39491 83.89716,-9.44942 64.73782,-59.07078 64.73782,-73.74014"
     id="path40"
     sodipodi:nodetypes="csc" />
  <!-- Arrow: return to client -> client end -->
  <path
     class="arrow dashed"
     d="m 550,640 c 0,-11.19588 17.30564,-31.0934 78.41904,-35.93822 55.66474,-4.41288 154.98911,-2.2329 198.11888,-8.45041 C 905.23132,584.26708 890,570.58384 890,545"
     id="path41"
     sodipodi:nodetypes="cssc" />
  <text
     class="note"
     x="715.10321"
     y="620"
     id="text41"
     style="font-style:italic;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">fault on return → restore</text>
  <!-- Optional: multiple clients reuse same image -->
  <rect
     class="clientbox"
     x="60"
     y="560"
     width="160"
     height="40"
     opacity="0.0"
     id="rect41" />
  <rect
     class="clientbox"
     x="60"
     y="445"
     width="300"
     height="100"
     opacity="0.0"
     id="rect42" />
  <rect
     class="clientbox"
     x="60"
     y="445"
     width="300"
     height="100"
     opacity="0.0"
     id="rect43" />
  <!-- Secondary client (reuse) -->
  <rect
     class="clientbox"
     x="60"
     y="360"
     width="220"
     height="40"
     opacity="0.0"
     id="rect44" />
  <rect
     class="clientbox"
     x="1060"
     y="445"
     width="100"
     height="100"
     opacity="0.0"
     id="rect45" />
  <!-- Side note box -->
  <rect
     class="lane"
     x="880"
     y="90"
     width="300"
     height="150"
     id="rect46" />
  <text
     class="label"
     x="895"
     y="120"
     id="text46"
     style="font-style:normal;font-variant:normal;font-weight:600;font-stretch:normal;font-size:15px;line-height:normal;font-family:'Helvetica Neue', Arial, sans-serif">Sharing Mutability</text>
  <text
     class="small"
     x="895"
     y="140"
     id="text47">• Image mapped by multiple clients</text>
  <text
     class="small"
     x="895"
     y="160"
     id="text48">• Writes by subcontext routines</text>
  <text
     class="small"
     x="895"
     y="180"
     id="text49">  persist to file lazily (shared)</text>
  <!-- Legend -->
  <rect
     class="lane"
     x="819.97205"
     y="659.97205"
     width="333.49927"
     height="100.05586"
     id="rect49" />
  <text
     class="label"
     x="835"
     y="688"
     id="text50">Legend</text>
  <rect
     class="box"
     x="835"
     y="700"
     width="16"
     height="16"
     id="rect50" />
  <text
     class="small"
     x="857"
     y="713"
     id="text51">Server actions</text>
  <rect
     class="disk"
     x="980"
     y="700"
     width="16"
     height="16"
     id="rect51" />
  <text
     class="small"
     x="1002"
     y="713"
     id="text52">Image file (persistence)</text>
  <rect
     class="clientbox"
     x="835"
     y="725"
     width="16"
     height="16"
     id="rect52" />
  <text
     class="small"
     x="857"
     y="738"
     id="text53">Client actions</text>
  <rect
     class="mmbox"
     x="980"
     y="725"
     width="16"
     height="16"
     id="rect53" />
  <text
     class="small"
     x="1002"
     y="738"
     id="text54">Matchmaker actions</text>
  <text
     xml:space="preserve"
     style="font-size:22.6667px;font-family:Mokoto;-inkscape-font-specification:'Mokoto, Normal';text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#ffffff;stroke:#000000"
     x="389.22021"
     y="655.61615"
     id="text58"><tspan
       sodipodi:role="line"
       id="tspan58"></tspan></text>
</svg>
